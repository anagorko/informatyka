USE malware;

DROP TABLE IF EXISTS malware;

CREATE TABLE malware(
data DATE,
ip VARCHAR(100),
opis VARCHAR(100),
asn INT,
url VARCHAR(100)
);

LOAD DATA LOCAL INFILE '../../../zbior_zadan/111/malware.txt'
INTO TABLE malware LINES TERMINATED BY '\r\n' IGNORE 1 LINES;

DROP TABLE IF EXISTS asn;

CREATE TABLE asn(
asn INT,
id_kraju VARCHAR(100),
region VARCHAR(100),
siec VARCHAR(100)
);

LOAD DATA LOCAL INFILE '../../../zbior_zadan/111/asn.txt'
INTO TABLE asn LINES TERMINATED BY '\r\n' IGNORE 1 LINES;


DROP TABLE IF EXISTS kraje;

CREATE TABLE kraje(
kraj VARCHAR(100),
id_kraju VARCHAR(100)
);

LOAD DATA LOCAL INFILE '../../../zbior_zadan/111/kraje.txt'
INTO TABLE kraje LINES TERMINATED BY '\r\n' IGNORE 1 LINES;

#111.1
/*
SELECT kraj, opis, url
FROM malware
	JOIN asn ON asn.asn = malware.asn
	JOIN kraje ON kraje.id_kraju = asn.id_kraju
WHERE opis LIKE '%phish%'
	OR opis LIKE '%Phish%';
*/
#111.2
/*
SELECT siec, kraj, COUNT( distinct url ) AS ilosc_adresow_url, COUNT( distinct ip ) AS ilosc_adresow_ip, COUNT(*) AS ile
FROM malware  
        JOIN asn ON asn.asn = malware.asn
        JOIN kraje ON kraje.id_kraju = asn.id_kraju
GROUP BY siec
ORDER BY ile DESC
LIMIT 5;
*/
#111.3
#a)
/*
SELECT COUNT( distinct substring_index(url, '/', 1)) as liczba_domen
FROM malware
*/
#b)
/*
SELECT substring_index(url, '/', 1) as domena, COUNT( distinct ip) as ilosc_adresow_ip 
FROM malware
GROUP BY domena
HAVING ilosc_adresow_ip > 1
*/
#111.4
/*
SELECT MONTH(data), region, COUNT(*) as liczba_pozycji_zlosliwego_oprogramowania
FROM malware
	JOIN asn ON asn.asn = malware.asn
WHERE NOT( MONTH(data) LIKE 1 AND YEAR(data) LIKE 2015)
GROUP BY MONTH(data),region
*/
#111.5
/*
SELECT kraj, CASE WHEN url LIKE '%.png' THEN 'png' ELSE 'jpg' END as format, COUNT(*) as ilosc
FROM malware
	JOIN asn ON asn.asn  = malware.asn
	JOIN kraje ON kraje.id_kraju = asn.id_kraju
WHERE url LIKE '%.png' OR url LIKE '%.jpg'
GROUP BY kraj, format
*/
